/*****************************************************************************
*																			 *
* ------------------------------- cdlist.c --------------------------------   *
*																			 *
*****************************************************************************/
#include<stdlib.h>
#include<string.h>

#include "cdlist.h"

/*****************************************************************************
*																			 *
* ------------------------------ cdlist_init ------------------------------   *
*																			 *
*****************************************************************************/

void cdlist_init(CDList *list, void(*destroy)(void *data)) {
	/*****************************************************************************
	*																			 *
	* Initialize the list.														 *
	*																			 *
	*****************************************************************************/
	list->size = 0;
	list->destroy = destroy;
	list->head = NULL;

	return;

}

/*****************************************************************************
*																			 *
* ---------------------------- cdlist_destroy -----------------------------   *
*																			 *
*****************************************************************************/

void cdlist_destroy(CDList *list)
{
	void *data;
	/*****************************************************************************
	*																			 *
	* Remove each element.														 *
	*																			 *
	*****************************************************************************/
	while (cdlist_size(list) > 0) {
		if (cdlist_rem(list, list->head, (void **)&data) == 0 && list->destroy != NULL) {
			/***********************************************************************
			*																	   *
			* Call a user-defined function to free dynamically allocated data.	   *
			*																	   *
			***********************************************************************/
			list->destroy(data);
		}
	}

	/*****************************************************************************
	*																			 *
	* No operations are allowed now, but clear the structure as a precaution.	 *
	*																			 *
	*****************************************************************************/

	memset(list, 0, sizeof(CDList));

	return;

}

/*****************************************************************************
*																			 *
* ---------------------------- cdlist_ins_next ----------------------------  *
*																			 *
*****************************************************************************/
int cdlist_ins_next(CDList *list, CDListElmt *element, const void *data) {
	CDListElmt *new_element;
	/*****************************************************************************
	*																			 *
	* Allocate storage for the element.											 *
	*																			 *
	*****************************************************************************/
	if ((new_element = (CDListElmt*)malloc(sizeof(CDListElmt))) == NULL)
		return -1;

	/*****************************************************************************
	*																			 *
	* Insert the element into the list.										     *
	*																			 *
	*****************************************************************************/
	new_element->data = (void *)data;

	if (cdlist_size(list) == 0) {
		/**************************************************************************
		*																		  *
		* Handle insertion when the list is empty.								  *
		*																		  *
		**************************************************************************/
		new_element->next = new_element;
		new_element->prev = new_element;
		list->head = new_element;

	}
	else {
		/**************************************************************************
		*																		  *
		* Handle insertion when the list is not empty.							  *
		*																		  *
		**************************************************************************/
		new_element->next = element->next;
		new_element->prev = element;
		element->next->prev = new_element;
		element->next = new_element;
	}

	/*****************************************************************************
	*																			 *
	* Adjust the size of the list to account for the inserted element.			 *
	*																			 *
	*****************************************************************************/

	list->size++;
	
	return 0;


}

/*****************************************************************************
*																			 *
* ---------------------------- cdlist_ins_prev ----------------------------   *
*																			 *
*****************************************************************************/
int cdlist_ins_prev(CDList *list, CDListElmt *element, const void *data) {
	CDListElmt *new_element;
	/*****************************************************************************
	*																			 *
	* Allocate storage for the element.											 *
	*																			 *
	*****************************************************************************/
	if ((new_element = (CDListElmt*)malloc(sizeof(CDListElmt))) == NULL)
		return -1;

	/*****************************************************************************
	*																			 *
	* Insert the element into the list.										     *
	*																			 *
	*****************************************************************************/
	new_element->data = (void *)data;

	if (cdlist_size(list) == 0) {
		/**************************************************************************
		*																		  *
		* Handle insertion when the list is empty.								  *
		*																		  *
		**************************************************************************/
		new_element->next = new_element;
		new_element->prev = new_element;
		list->head = new_element;

	}
	else {
		/**************************************************************************
		*																		  *
		* Handle insertion when the list is not empty.							  *
		*																		  *
		**************************************************************************/
		new_element->next = element;
		new_element->prev = element->prev;
		element->prev->next = new_element;
		element->prev = new_element;
	}

	/*****************************************************************************
	*																			 *
	* Adjust the size of the list to account for the inserted element.			 *
	*																			 *
	*****************************************************************************/

	list->size++;

	return 0;


}

/*****************************************************************************
*																			 *
* ---------------------------- clist_rem ----------------------------        *
*																			 *
*****************************************************************************/
int cdlist_rem(CDList *list, CDListElmt *element, void **data) {
	CDListElmt *old_element;
	/*****************************************************************************
	*																			 *
	* Do not allow removal from an empty list.									 *
	*																			 *
	*****************************************************************************/
	if (element == NULL || cdlist_size(list) == 0)
		return -1;

	/*****************************************************************************
	*																			 *
	* Remove the element from the list.											 *
	*																			 *
	*****************************************************************************/

	*data = element->data;

	if (element->next == element) {
		/**************************************************************************
		*																		  *
		* Handle removing the last element.										  *
		*																		  *
		**************************************************************************/
		old_element = element->next;
		list->head = NULL;
	}
	else {
		/**************************************************************************
		*																		  *
		* Handle removing other than the last element.							  *
		*																		  *
		**************************************************************************/
		old_element = element;
		element->prev->next = element->next;
		element->next->prev = element->prev;
		if (old_element == cdlist_head(list))
			list->head = old_element->next;
	}
	/*****************************************************************************
	*																			 *
	* Free the storage allocated by the abstract datatype.						 *
	*																			 *
	*****************************************************************************/
	free(old_element);
	/*****************************************************************************
	*																			 *
	* Adjust the size of the list to account for the removed element.			 *
	*																			 *
	*****************************************************************************/
	list->size--;
	return 0;
}